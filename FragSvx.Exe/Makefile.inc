#
# Pull in project common makefile helpers
#
!include ..\common.inc

#
# This builds a .REG file that creates all the necessary COM registry entries
# for FRAGSVX.EXE, creates the service and then executes the reg file. Used
# for debug builds
#
FRAGSVX_OUT_PATH=$(MAKEDIR_LOWERCASE:fragsvx.exe=)out\$O

SetupFragSvx:
   $(TYPE) <<$(OBJ_PATH)\$O\$(TARGETNAME).$(TARGETEXT).reg
Windows Registry Editor Version 5.00

[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\AppID\$(TARGETNAME).$(TARGETEXT)]
"AppID"="{7C1A3EB5-37A0-4BC2-B0E5-F3C5BF1FCB5D}"

[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\AppID\{7C1A3EB5-37A0-4BC2-B0E5-F3C5BF1FCB5D}]
@="FragSvx"
"LaunchPermission"=hex:01,00,04,80,70,00,00,00,7c,00,00,00,00,00,00,00,14,00,\
  00,00,02,00,5c,00,04,00,00,00,00,00,14,00,0b,00,00,00,01,01,00,00,00,00,00,\
  05,04,00,00,00,00,00,18,00,0b,00,00,00,01,02,00,00,00,00,00,05,20,00,00,00,\
  20,02,00,00,00,00,14,00,0b,00,00,00,01,01,00,00,00,00,00,05,06,00,00,00,00,\
  00,14,00,0b,00,00,00,01,01,00,00,00,00,00,05,12,00,00,00,01,01,00,00,00,00,\
  00,05,12,00,00,00,01,01,00,00,00,00,00,05,12,00,00,00
"LocalService"="FragSvx"
"ServiceParameters"="-COM"

[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID\{FE0758EC-102C-4228-BB9F-0AA01DB604CF}]
@="FSxServiceManager"
"AppID"="{7C1A3EB5-37A0-4BC2-B0E5-F3C5BF1FCB5D}"

[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID\{FE0758EC-102C-4228-BB9F-0AA01DB604CF}\TypeLib]
@="{EF69B978-A080-4318-8CD1-8B68F6352421}"

[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{0A1CA5C0-00DF-43cf-A2BD-95118EB5196D}]
@="IFSxFileDefragmenter"

[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{0A1CA5C0-00DF-43cf-A2BD-95118EB5196D}\ProxyStubClsid]
@="{00020424-0000-0000-C000-000000000046}"

[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{0A1CA5C0-00DF-43cf-A2BD-95118EB5196D}\ProxyStubClsid32]
@="{00020424-0000-0000-C000-000000000046}"

[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{0A1CA5C0-00DF-43cf-A2BD-95118EB5196D}\TypeLib]
@="{EF69B978-A080-4318-8CD1-8B68F6352421}"
"Version"="1.0"

[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{D26AF61A-609C-430F-9944-2F9DA30B0D63}]
@="IFSxFileDefragmenter"

[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{D26AF61A-609C-430F-9944-2F9DA30B0D63}\ProxyStubClsid]
@="{00020424-0000-0000-C000-000000000046}"

[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{D26AF61A-609C-430F-9944-2F9DA30B0D63}\ProxyStubClsid32]
@="{00020424-0000-0000-C000-000000000046}"

[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Interface\{D26AF61A-609C-430F-9944-2F9DA30B0D63}\TypeLib]
@="{EF69B978-A080-4318-8CD1-8B68F6352421}"
"Version"="1.0"

[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\TypeLib\{EF69B978-A080-4318-8CD1-8B68F6352421}]

[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\TypeLib\{EF69B978-A080-4318-8CD1-8B68F6352421}\1.0]
@="FragExt Service"

[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\TypeLib\{EF69B978-A080-4318-8CD1-8B68F6352421}\1.0\0]

!if "$(_BUILDARCH)"=="x86"
[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\TypeLib\{EF69B978-A080-4318-8CD1-8B68F6352421}\1.0\0\win32]
!else
[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\TypeLib\{EF69B978-A080-4318-8CD1-8B68F6352421}\1.0\0\win64]
!endif
@="$(FRAGSVX_OUT_PATH:\=\\)\\$(TARGETNAME).$(TARGETEXT)"

[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\TypeLib\{EF69B978-A080-4318-8CD1-8B68F6352421}\1.0\FLAGS]
@="0"

[HKEY_LOCAL_MACHINE\SOFTWARE\Classes\TypeLib\{EF69B978-A080-4318-8CD1-8B68F6352421}\1.0\HELPDIR]
@="$(FRAGSVX_OUT_PATH:\=\\)"
<<$(BUILD_KEEP)
!if !$(FREEBUILD)
   -SC delete FragSvx
!endif
   -SC create FragSvx binPath= $(FRAGSVX_OUT_PATH)\$(TARGETNAME).$(TARGETEXT) depend= RPCSS DisplayName= "FragExt Defragmenter"
   -SC privs FragSvx SeManageVolumePrivilege/SeIncreaseWorkingSetPrivilege/SeImpersonatePrivilege
   -REGEDIT -s "$(OBJ_PATH)\$O\$(TARGETNAME).$(TARGETEXT).reg"

CustomPreBuild_Target:

CustomBuild_Target: 
   
CustomPostBuild_Target: \
   CopyToSharedOut      \
   SetupFragSvx
   COPY /Y "$(OBJ_PATH)\$O\FragSvx.h" "$(MAKEDIR_LOWERCASE:fragsvx.exe=)inc\FragSvx.h"
